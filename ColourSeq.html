<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Color Sequence Master</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
<style>
/* --- Root Variables for Dark Mode (Default) --- */
:root {
--color-primary: #3f68a8;       /* Muted Blue */
--color-secondary: #00bcd4;     /* Cyan Accent */
--color-accent: #ff9800;        /* Gold/Orange Accent */
--color-error: #f44336;
--color-success: #8bc34a;
--color-text: #e0e6f0;
--box-background: rgba(25, 35, 55, 0.9);
--modal-bg: #101a2e;
--modal-header: var(--color-accent);
}
/* --- Light Mode Overrides (FIXED: Contrast and Aesthetics) --- */
body.light-mode {
background: linear-gradient(135deg, #ffffff, #c7e0ff, #ffffff);
background-size: 400% 400%;
color: #333;
--color-primary: #4db6ac;       /* Deep Teal */
--color-secondary: #008c99;
--color-accent: #e65100;
--color-error: #c62828;
--color-success: #4caf50;
--color-text: #333;
--box-background: rgba(255, 255, 255, 0.95);
--modal-bg: #f5f8ff;
--modal-header: var(--color-accent);
}

body {
margin: 0;
height: 100vh;
display: flex;
justify-content: center;
align-items: center;
font-family: 'Montserrat', sans-serif;
/* DISTINCT BACKGROUND: Deep Cosmic Blue to Indigo */
background: linear-gradient(135deg, #000428, #004e92, #000428);
background-size: 400% 400%;
animation: gradientBG 15s ease infinite;
color: var(--color-text);
overflow: hidden;
transition: color 0.3s, background 0.3s;
}
@keyframes gradientBG {
0% { background-position: 0% 50%; }
50% { background-position: 100% 50%; }
100% { background-position: 0% 50%; }
}
/* --- SHARED ELEMENTS (Buttons, Banners, etc.) --- */

#game-box {
background: var(--box-background);
backdrop-filter: blur(18px);
border-radius: 15px;
border: 1px solid rgba(255, 255, 255, 0.1);
/* FIX (P5): Reduced padding/height for footer clearance */
padding: 25px 45px 30px; 
width: 500px;
box-shadow: 0 0 50px rgba(0,0,0,0.7);
text-align: center;
position: relative;
height: auto;
overflow: hidden;
transition: all 0.3s ease;
z-index: 1;
}
/* FIX (P1): Improved light mode game box aesthetics */
body.light-mode #game-box {
    border: 1px solid rgba(0, 0, 0, 0.15);
    box-shadow: 0 0 30px rgba(0,0,0,0.25);
    background: var(--box-background); 
}

h2 { margin-bottom: 5px; font-size: 26px; font-weight: 700; letter-spacing: 2px; color: var(--color-text); text-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
}
body.light-mode h2 { text-shadow: none; color: var(--color-primary); }
#score-display { font-size: 14px; font-weight: 500; margin-bottom: 25px; color: var(--color-secondary); text-transform: uppercase; }

button { background: var(--color-primary); border: none; padding: 12px 22px; margin: 8px 6px; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 700;
cursor: pointer; transition: 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-transform: uppercase; letter-spacing: 0.5px; min-width: 120px; border-bottom: 3px solid var(--color-secondary);
}
button:hover { background: #507aad; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.7); }
#restartBtn { background: #616161; border-bottom: 3px solid #9e9e9e; }
#restartBtn:hover { background: #757575; }
.msg { padding: 12px; margin-top: 20px; border-radius: 6px; font-weight: 700; font-size: 15px; min-height: 20px; }
.msg.win { background: var(--color-success); color: #fff; }
.msg.lose { background: var(--color-error); color: #fff; }
.msg.correct { background: rgba(0, 255, 0, 0.15); color: var(--color-success); border: 1px solid var(--color-success); }
/* --- DIFFICULTY SELECTOR STYLES --- */
#difficulty-selector {
display: flex;
justify-content: center;
gap: 10px;
margin-bottom: 25px;
}
.difficulty-btn {
background: var(--color-primary);
border-bottom: 3px solid var(--color-secondary);
font-size: 14px;
padding: 10px 15px;
min-width: 100px;
margin: 0;
opacity: 0.7;
transition: all 0.2s ease;
}
.difficulty-btn.selected {
opacity: 1;
background: var(--color-accent);
border-bottom: 3px solid #e65100;
transform: translateY(-3px) scale(1.05);
box-shadow: 0 6px 15px rgba(0,0,0,0.7);
}
/* --- COLOR BUTTONS SPECIFIC STYLES --- */
#color-buttons {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 20px;
margin: 20px auto;
width: 400px;
}
/* Adjust grid for 6 and 8 buttons */
#color-buttons.cols-3 {
grid-template-columns: repeat(3, 1fr);
width: 450px;
}
#color-buttons.cols-4 {
grid-template-columns: repeat(4, 1fr);
width: 480px;
}
.color-btn {
height: 100px;
width: 100%;
/* FIX (P1): Change button border color in light mode for better contrast */
border: 8px solid var(--box-background); 
border-radius: 10px;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
transition: all 0.2s ease-out;
cursor: pointer;
pointer-events: none;
display: none;
}

.color-btn.visible {
display: block;
}
/* Base Colors */
#red-btn { background-color: #f44336; }
#green-btn { background-color: #4CAF50; }
#blue-btn { background-color: #2196F3; }
#yellow-btn { background-color: #FFEB3B; }
#purple-btn { background-color: #9c27b0; }
#cyan-btn { background-color: #00bcd4; }
#orange-btn { background-color: #ff5722; }
#teal-btn { background-color: #009688; }
/* Active/Flash State (System sequence playback) */
.color-btn.active-flash {
box-shadow: 0 0 30px 5px var(--flash-color);
transform: scale(1.05);
filter: brightness(1.2);
transition: all 0.05s linear;
}

/* New: User Click Animation */
.color-btn.user-click-effect {
box-shadow: 0 0 15px 3px var(--color-text);
transform: scale(0.95);
transition: all 0.05s ease-out;
}
/* --- BANNERS, CONFETTI, MODALS (Standard Styles) --- */
#highScoreBanner, #gameOverBanner {
position: fixed; top: 0; left: 50%; transform: translateX(-50%) translateY(-100%);
color: white; padding: 10px 20px; border-radius: 0 0 10px 10px;
font-size: 16px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 200;
opacity: 0; visibility: hidden; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
letter-spacing: 1px;
}
#highScoreBanner { background: var(--color-success); border-bottom: 5px solid #388e3c; }
#gameOverBanner { background: var(--color-error); border-bottom: 5px solid #b71c1c; }

#highScoreBanner.active, #gameOverBanner.active {
transform: translateX(-50%) translateY(0);
opacity: 1; visibility: visible;
}
.confetti {
position: fixed; top: -10px; width: 10px; height: 10px;
transform: rotate(45deg); opacity: 0;
animation: fall 2.5s ease-out forwards;
z-index: 10;
}
@keyframes fall {
0% { transform: translateY(-100vh) rotate(45deg); opacity: 1; }
100% { transform: translateY(100vh) rotate(500deg); opacity: 0; }
}
.fixed-btn { position: fixed; background: var(--color-primary); border: none; padding: 10px 18px; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600;
cursor: pointer; transition: 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 101; margin: 0; text-transform: uppercase; border-bottom: 3px solid var(--color-secondary);
}
#indexBtn { position: fixed; top: 20px; left: 20px; right: auto; z-index: 105; font-size: 13px; }
#infoBtn { top: 20px; right: 20px; }
.floating-icon { position: fixed; bottom: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--modal-bg); color: white; line-height: 50px; text-align: center;
cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.2s, background 0.2s; z-index: 150; font-size: 28px; border: 2px solid var(--color-secondary);
}
#settingsIcon { right: 20px; font-size: 28px; }
#supportIcon { right: 80px; font-size: 24px; background: var(--color-primary); border: 2px solid var(--color-primary); }
.floating-icon:hover { transform: scale(1.1) rotate(5deg); }
.fixed-panel-common { position: fixed; right: 20px; width: 300px; background: rgba(0, 0, 0, 0.9); border-radius: 10px; padding: 20px; text-align: left;
font-size: 14px; line-height: 1.6; color: var(--color-text); z-index: 100; opacity: 0; visibility: hidden; transition: 0.3s ease; transform: translateX(100%); }
.fixed-panel-common.visible { opacity: 1; visibility: visible; transform: translateX(0); }
#instructions { top: 75px; border-left: 3px solid var(--color-secondary); max-height: 500px; overflow-y: auto; padding-bottom: 10px; }

.floating-modal { position: fixed; bottom: 80px; right: 20px; width: 300px; background: var(--modal-bg); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.7);
z-index: 200; transform: scale(0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; transform-origin: bottom right; }
.floating-modal.visible { transform: scale(1); opacity: 1; visibility: visible; }
.modal-header { background: var(--color-primary); color: white; padding: 10px 15px; border-radius: 10px 10px 0 0; font-weight: 700; display: flex; justify-content: space-between;
align-items: center; }
.chat-close-btn { background: transparent; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0; min-width: auto; box-shadow: none; margin: 0;
border-bottom: none; }
.modal-body { padding: 15px; max-height: 350px; overflow-y: auto; }
.setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
.chat-message { padding: 8px; margin-bottom: 10px; border-radius: 8px; line-height: 1.4; }
.ai-message { background: rgba(0, 188, 212, 0.1); color: var(--color-text); }
body.light-mode .ai-message { color: var(--color-primary); }

.chat-option-btn { 
    background: var(--color-secondary); 
    /* FIX (P4): Ensure text color contrasts with the cyan background */
    color: var(--modal-bg); 
    font-size: 13px; font-weight: 700; width: 100%; margin: 5px 0; border-bottom: 3px solid #0097a7; 
}
.chat-info-panel { padding: 10px; border: 1px solid var(--color-accent); border-radius: 8px; margin-top: 10px; }
#footer { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 12px; color: rgba(255, 255, 255, 0.5);
text-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 5; }
</style>
</head>
<body class="dark-mode">

<div id="highScoreBanner">New Longest Sequence! 🏅 </div>
<div id="gameOverBanner"> ❌ SEQUENCE FAILURE! ❌ </div>
<button id="indexBtn" class="fixed-btn" onclick="window.location.href='index.html'">&lt; BACK TO INDEX</button>
<button id="infoBtn" class="fixed-btn">Protocol | RULES</button>

<div id="settingsIcon" class="floating-icon" onclick="toggleSettingsModal()"> ⚙️ </div>
<div id="supportIcon" class="floating-icon" onclick="toggleSupportModal()"> 💬 </div>

<div id="instructions" class="fixed-panel-common">
<h4 id="rules-title">PROTOCOL GUIDELINES</h4>
<div id="rules-content">
    <p>The **Color Sequence Master** is a pattern replication protocol designed to test memory and focus. Your objective is to successfully replicate the sequence of colored buttons flashed by the system.</p>
    <ul>
        <li>**Sequence Playback**: The system will play a sequence of colors. Each color corresponds to a tone.</li>
        <li>**User Input**: After the sequence, the buttons will activate. You must press the buttons in the *exact same order*.</li>
        <li>**Progression**: A successful sequence replication increases the score by 1 (or 2 on Hard mode) and adds new colors to the sequence for the next round.</li>
        <li>**Failure**: One incorrect click results in a **Sequence Failure** and ends the protocol session.</li>
    </ul>
    <p>Choose your difficulty level wisely. Good luck.</p>
</div>
<hr style="border-color: rgba(255,255,255,0.2); margin-top: 15px;">
<small style="display: block; text-align: center; color: var(--color-text);">System developed by **Aarav Sinha**</small>
</div>
<div id="settingsModal" class="floating-modal">
<div class="modal-header">
<span> ⚙️ SYSTEM SETTINGS</span>
<button class="chat-close-btn" onclick="closeSettingsModal()"> ✕ </button>
</div>
<div class="modal-body">
<h4>INTERFACE PREFERENCES</h4>
<div class="setting-row">
<label for="themeToggle">Light Mode</label>
<input type="checkbox" id="themeToggle">
</div>
<div class="setting-row" style="border-bottom: none;">
<label for="soundToggle">Sound Effects (Flash/Click)</label>
<input type="checkbox" id="soundToggle" checked>
</div>

<button onclick="colorSeq.resetHighScoreOnly()" style="background: var(--color-error); margin-top: 15px; width: 100%;">WIPE HIGH SCORE</button>
</div>
</div>
<div id="supportModal" class="floating-modal">
<div class="modal-header">
<span> 💬 AI Assistant: Protocol Support</span>
<button class="chat-close-btn" onclick="closeSupportModal()"> ✕ </button>
</div>
<div id="supportBody" class="modal-body">
</div>

<div id="support-menu-options-template" style="display:none;">
<button class="chat-option-btn" onclick="colorSeq.handleMenuSelection('stats', this)"> 📈 Check Protocol Metrics (Stats)</button>
<button class="chat-option-btn" onclick="colorSeq.handleMenuSelection('faq', this)"> ❓ Review Support FAQ</button>
<button class="chat-option-btn" onclick="colorSeq.handleMenuSelection('lore', this)"> 🌐 Read Mission Briefing (Lore)</button>
</div>

<div id="supportContentArea" style="display: none;">
<div id="statsPanelContent" class="chat-info-panel">
<h4>PROTOCOL METRICS</h4>
<p>Longest Sequence: <span id="stat-max-streak">0</span></p>
<button onclick="colorSeq.resetHighScoreOnly()" style="background: var(--color-error); margin-top: 15px; width: 100%;">WIPE HIGH SCORE</button>
<button onclick="colorSeq.returnToMainMenu()" style="background: var(--color-primary); margin-top: 8px; width: 100%;">BACK TO MENU</button>
</div>
<div id="faqPanelContent" class="chat-info-panel">
<h4>SUPPORT FAQ</h4>
<p>FAQ for this module is currently unavailable.</p>
<button onclick="colorSeq.returnToMainMenu()" style="background: var(--color-primary); margin-top: 8px; width: 100%;">BACK TO MENU</button>
</div>
<div id="lorePanelContent" class="chat-info-panel">
<h4>MISSION BRIEFING</h4>
<p style="font-style: italic;">"You are a User. Color Sequence Master is a memory and focus simulation. Replicate the system's output sequence to progress. Failure to replicate will result in system self-wipe."</p>
<button onclick="colorSeq.returnToMainMenu()" style="background: var(--color-primary); margin-top: 8px; width: 100%;">BACK TO MENU</button>
</div>
</div>
</div>
<div id="game-box">

<div id="colorSequenceMaster">
<h2> 🧠 Color Sequence Master</h2>

<p id="score-display">
CURRENT SEQUENCE: <span id="currentScore">0</span> |
🏅 LONGEST: <span id="highScore">N/A</span>
</p>

<div id="difficulty-selector">
<button class="difficulty-btn" data-level="easy" onclick="colorSeq.setDifficulty('easy')">EASY (4 Colors)</button>
<button class="difficulty-btn" data-level="medium" onclick="colorSeq.setDifficulty('medium')">MEDIUM (6 Colors)</button>
<button class="difficulty-btn" data-level="hard" onclick="colorSeq.setDifficulty('hard')">HARD (8 Colors)</button>
</div>

<div id="game-area">
<div id="color-buttons" class="cols-4">
<div id="red-btn" class="color-btn" data-color="red" onmousedown="colorSeq.handleUserClick('red')"></div>
<div id="green-btn" class="color-btn" data-color="green" onmousedown="colorSeq.handleUserClick('green')"></div>
<div id="blue-btn" class="color-btn" data-color="blue" onmousedown="colorSeq.handleUserClick('blue')"></div>
<div id="yellow-btn" class="color-btn" data-color="yellow" onmousedown="colorSeq.handleUserClick('yellow')"></div>
<div id="purple-btn" class="color-btn" data-color="purple" onmousedown="colorSeq.handleUserClick('purple')"></div>
<div id="cyan-btn" class="color-btn" data-color="cyan" onmousedown="colorSeq.handleUserClick('cyan')"></div>
<div id="orange-btn" class="color-btn" data-color="orange" onmousedown="colorSeq.handleUserClick('orange')"></div>
<div id="teal-btn" class="color-btn" data-color="teal" onmousedown="colorSeq.handleUserClick('teal')"></div>
</div>

<button id="startBtn" onclick="colorSeq.startGame()"> ▶️ START PROTOCOL (Current: Medium)</button>
<button id="restartBtn" onclick="colorSeq.restartGame()" style="display:none;">RESET GAME</button>

<div class="msg" id="message">Awaiting protocol activation...</div>
</div>
</div>
</div>

<div id="footer">
Developed & Branded by Aarav Sinha
</div>
<script>
// --- GLOBAL STATE & UTILITIES ---
let confettiInterval;
let stats = {
soundEnabled: true,
theme: 'dark',
difficulty: 'medium'
};
const body = document.body;
const instructionsBox = document.getElementById("instructions");
const settingsModal = document.getElementById("settingsModal");
const supportModal = document.getElementById("supportModal");
const soundToggle = document.getElementById('soundToggle');
const themeToggle = document.getElementById('themeToggle');
const difficultyButtons = Array.from(document.querySelectorAll('.difficulty-btn'));
const colorButtonsContainer = document.getElementById('color-buttons');
const allColorButtons = Array.from(document.querySelectorAll('.color-btn'));
const supportBody = document.getElementById('supportBody');
const supportMenuTemplate = document.getElementById('support-menu-options-template');
const supportContentArea = document.getElementById('supportContentArea');
// Difficulty settings: [max_colors, flash_duration_ms, pause_duration_ms, sequence_increment]
const DIFFICULTY_SETTINGS = {
'easy': [4, 500, 300, 1],    // 4 colors, slow speed, +1 increment
'medium': [6, 350, 150, 1],  // 6 colors, medium speed, +1 increment
'hard': [8, 250, 100, 2]     // 8 colors, fast speed, +2 increment (major difficulty spike)
};
// All available colors
const ALL_COLORS = ['red', 'green', 'blue', 'yellow', 'purple', 'cyan', 'orange', 'teal'];
// Map colors to their CSS values for flash effect
const COLOR_MAP = {
'red': '#f44336',
'green': '#4CAF50',
'blue': '#2196F3',
'yellow': '#FFEB3B',
'purple': '#9c27b0',
'cyan': '#00bcd4',
'orange': '#ff5722',
'teal': '#009688'
};
// --- AUDIO CONTEXT AND SOUND GENERATION ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
// Frequencies for a musical scale (C4 to E5)
const TONE_FREQS = {
'red': 261.6,
'green': 330.0,
'blue': 392.0,
'yellow': 440.0,
'purple': 494.0,
'cyan': 523.2,
'orange': 587.3,
'teal': 659.2,
'CORRECT': 880.0, // A5 for success ping
'ERROR': 110.0,    // A2 for low error buzz
// High Score Notes (C5, E5, G5)
'HS_NOTE_1': 523.2,
'HS_NOTE_2': 659.2,
'HS_NOTE_3': 783.9,
};
function ensureAudioContext() {
if (!audioCtx) {
audioCtx = new AudioContext();
}
}
/**
* Generates and plays a tone using the Web Audio API.
* @param {number} frequency - The frequency in Hz.
* @param {number} duration_ms - The duration in milliseconds.
* @param {string} waveType - 'sine', 'square', 'sawtooth', or 'triangle'.
* @param {number} decay - Time in seconds for the volume to fade out.
*/
function generateTone(frequency, duration_ms = 100, waveType = 'sine', decay = 0.05) {
if (!stats.soundEnabled) return;

ensureAudioContext();

const oscillator = audioCtx.createOscillator();
const gainNode = audioCtx.createGain();
oscillator.type = waveType;
oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);

oscillator.connect(gainNode);
gainNode.connect(audioCtx.destination);

const now = audioCtx.currentTime;
const duration_s = duration_ms / 1000;

gainNode.gain.setValueAtTime(1, now);
// Schedule rapid decay to 0.001 (near silence)
gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration_s + decay);
oscillator.start();
oscillator.stop(now + duration_s + decay);
}
/**
* Plays a three-note fanfare for a high score.
*/
function playHighScoreSound() {
if (!stats.soundEnabled) return;
ensureAudioContext();
// C5, E5, G5 sequence (Tada!)
generateTone(TONE_FREQS['HS_NOTE_1'], 80, 'triangle', 0.05);
setTimeout(() => {
generateTone(TONE_FREQS['HS_NOTE_2'], 100, 'triangle', 0.05);
}, 100);
setTimeout(() => {
generateTone(TONE_FREQS['HS_NOTE_3'], 150, 'sine', 0.1);
}, 250);
}
// --- GAME LOGIC: COLOR SEQUENCE MASTER ---
const colorSeq = {
sequence: [],
userSequence: [],
currentRound: 0,
gameActive: false,
waitingForInput: false,
highScoreKey: 'colorSeqHighScore',

elements: {
currentScore: document.getElementById("currentScore"),
highScore: document.getElementById("highScore"),
message: document.getElementById("message"),
startBtn: document.getElementById("startBtn"),
restartBtn: document.getElementById("restartBtn"),
highScoreBanner: document.getElementById("highScoreBanner"),
gameOverBanner: document.getElementById("gameOverBanner"),
colorButtonsContainer: colorButtonsContainer,
colorButtons: allColorButtons
},

// --- INITIALIZATION & SETUP ---

// Load stats and preferences (theme, sound, high score)
loadStats: function() {
const storedStats = localStorage.getItem('colorSeqStats');
if (storedStats) {
const loadedStats = JSON.parse(storedStats);
stats.theme = loadedStats.theme || 'dark';
stats.soundEnabled = loadedStats.soundEnabled !== undefined ? loadedStats.soundEnabled : true;
stats.difficulty = loadedStats.difficulty || 'medium';
}

// Apply theme
if (stats.theme === 'light') {
body.classList.add('light-mode');
themeToggle.checked = true;
} else {
body.classList.remove('light-mode');
themeToggle.checked = false;
}

// Apply sound setting
soundToggle.checked = stats.soundEnabled;

// Load High Score
const storedHighScore = localStorage.getItem(this.highScoreKey);
if (storedHighScore) {
this.elements.highScore.textContent = storedHighScore;
} else {
this.elements.highScore.textContent = '0';
}
// Set initial difficulty button state
this.updateDifficultyDisplay(stats.difficulty);

// Initial support modal population
this.populateSupportModal();
},

// Save stats and preferences
saveStats: function() {
localStorage.setItem('colorSeqStats', JSON.stringify(stats));
},

// --- GAME FLOW CONTROLS ---

// Select difficulty
setDifficulty: function(level) {
if (this.gameActive) {
this.elements.message.textContent = "Cannot change settings during active protocol. Please reset.";
return;
}

stats.difficulty = level;
this.saveStats();
this.updateDifficultyDisplay(level);

// Update Start Button text
this.elements.startBtn.textContent = `▶️ START PROTOCOL (Current: ${level.toUpperCase()})`;
this.elements.message.textContent = `Protocol ready at ${level.toUpperCase()} difficulty. Press START.`;

// Adjust grid size for the selected difficulty
const maxColors = DIFFICULTY_SETTINGS[level][0];
this.elements.colorButtons.forEach((btn, index) => {
btn.classList.remove('visible');
if (index < maxColors) {
btn.classList.add('visible');
}
});

// Update grid layout class
this.elements.colorButtonsContainer.classList.remove('cols-3', 'cols-4');
if (maxColors === 6) {
this.elements.colorButtonsContainer.classList.add('cols-3');
} else if (maxColors === 8) {
this.elements.colorButtonsContainer.classList.add('cols-4');
}
},

// Update difficulty button visuals
updateDifficultyDisplay: function(currentLevel) {
difficultyButtons.forEach(btn => {
btn.classList.remove('selected');
if (btn.getAttribute('data-level') === currentLevel) {
btn.classList.add('selected');
}
});
},

// Start or reset the game
startGame: function() {
if (this.gameActive) return;

clearTimersAndEffects();
this.gameActive = true;
this.sequence = [];
this.currentRound = 0;
this.elements.currentScore.textContent = '0';
this.elements.startBtn.style.display = 'none';
this.elements.restartBtn.style.display = 'inline-block';
this.elements.message.textContent = "Sequence initiated. Pay close attention...";

this.elements.colorButtons.forEach(btn => btn.style.pointerEvents = 'none'); // Lock buttons

setTimeout(() => this.nextRound(), 1000);
},

restartGame: function() {
this.gameActive = false;
this.waitingForInput = false;
this.sequence = [];
this.userSequence = [];
this.currentRound = 0;
this.elements.currentScore.textContent = '0';
this.elements.startBtn.style.display = 'inline-block';
this.elements.restartBtn.style.display = 'none';
this.elements.message.textContent = `Protocol reset. Press START to begin the ${stats.difficulty.toUpperCase()} challenge.`;
clearTimersAndEffects();
this.elements.colorButtons.forEach(btn => btn.style.pointerEvents = 'none'); // Keep buttons locked
},

// Advance to the next round
nextRound: function() {
this.currentRound++;
this.userSequence = [];
this.waitingForInput = false;

this.elements.currentScore.textContent = (this.currentRound - 1).toString();
this.elements.message.textContent = `Sequence length: ${this.currentRound - 1}. Generating new command...`;

const [maxColors, flashDuration, pauseDuration, increment] = DIFFICULTY_SETTINGS[stats.difficulty];

// Add colors to sequence based on increment
for (let i = 0; i < increment; i++) {
const availableColors = ALL_COLORS.slice(0, maxColors);
const randomColor = availableColors[Math.floor(Math.random() * availableColors.length)];
this.sequence.push({ color: randomColor, duration: flashDuration });
}

this.playSequence(pauseDuration);
},

// Play the color sequence to the user
playSequence: function(pauseDuration) {
let i = 0;
const sequenceTimer = setInterval(() => {
if (i < this.sequence.length) {
const { color, duration } = this.sequence[i];
this.flashButton(color, duration);
i++;
} else {
clearInterval(sequenceTimer);
this.awaitUserInput();
}
}, this.sequence[i - 1]?.duration + pauseDuration || 1000); // Wait for the previous flash to end + pause
},

// Flash a single color button
flashButton: function(color, duration) {
const btn = document.getElementById(`${color}-btn`);

// Set flash-specific CSS variable for glow
btn.style.setProperty('--flash-color', COLOR_MAP[color]);

// Visual flash
btn.classList.add('active-flash');

// Sound
generateTone(TONE_FREQS[color], duration * 0.9, 'sine', 0.05);

setTimeout(() => {
btn.classList.remove('active-flash');
// Clear the flash color property
btn.style.removeProperty('--flash-color');
}, duration * 0.9);
},

// Enable user input
awaitUserInput: function() {
this.waitingForInput = true;
this.elements.message.textContent = `Awaiting input. Repeat the sequence of ${this.sequence.length} colors.`;

// Enable pointer events only on visible buttons
this.elements.colorButtons.forEach(btn => {
if (btn.classList.contains('visible')) {
btn.style.pointerEvents = 'auto';
}
});
},

// Handle user click on a color button
handleUserClick: function(color) {
if (!this.waitingForInput) return;

// Add user visual/sound feedback immediately
this.userClickEffect(color);
generateTone(TONE_FREQS[color], 80, 'square', 0.05);

this.userSequence.push(color);
const clickIndex = this.userSequence.length - 1;

// 1. Check if the current click is correct
if (this.userSequence[clickIndex] !== this.sequence[clickIndex].color) {
this.gameOver();
return;
}

// 2. Check if the sequence is complete
if (this.userSequence.length === this.sequence.length) {
this.waitingForInput = false; // Disable input
this.elements.colorButtons.forEach(btn => btn.style.pointerEvents = 'none'); // Lock buttons

this.elements.message.textContent = "CORRECT! Preparing next sequence...";
setTimeout(() => this.nextRound(), 1200);

// Check for High Score
const currentScore = this.currentRound - 1;
const highScore = parseInt(this.elements.highScore.textContent);
if (currentScore > highScore) {
this.elements.highScore.textContent = currentScore;
localStorage.setItem(this.highScoreKey, currentScore);
this.showBanner('highScore');
playHighScoreSound();
}
} else {
this.elements.message.textContent = `Correct so far. ${this.sequence.length - this.userSequence.length} remaining...`;
}
},

// User click visual effect
userClickEffect: function(color) {
const btn = document.getElementById(`${color}-btn`);
btn.classList.add('user-click-effect');
setTimeout(() => {
btn.classList.remove('user-click-effect');
}, 100);
},

// Game over logic
gameOver: function() {
this.gameActive = false;
this.waitingForInput = false;
this.elements.colorButtons.forEach(btn => btn.style.pointerEvents = 'none'); // Lock buttons

// Error sound
generateTone(TONE_FREQS['ERROR'], 500, 'sawtooth', 0.1);

this.elements.message.classList.add('lose');
this.elements.message.textContent = `FAILURE! You reached a sequence of ${this.currentRound - 1}. System self-wipe initiated.`;
this.showBanner('gameOver');

// Delay UI elements until after message
setTimeout(() => {
this.elements.startBtn.style.display = 'inline-block';
this.elements.restartBtn.style.display = 'none';
this.elements.message.classList.remove('lose');
this.elements.message.textContent = `Protocol terminated. Final score: ${this.currentRound - 1}. Press START to try again.`;
}, 2000);
},

// --- UI & MODAL FUNCTIONS ---

// Show/hide banners
showBanner: function(type) {
const banner = type === 'highScore' ? this.elements.highScoreBanner : this.elements.gameOverBanner;
banner.classList.add('active');

if (type === 'highScore') {
// Start confetti
startConfetti(3000);
}

setTimeout(() => {
banner.classList.remove('active');
}, 3500);
},

// Populates and resets the support modal to main menu
populateSupportModal: function() {
supportBody.innerHTML = '';
const initialMessage = document.createElement('div');
initialMessage.className = 'chat-message ai-message';
initialMessage.innerHTML = 'Hello User. I am the Protocol Support AI. How may I assist with the Color Sequence module?';
supportBody.appendChild(initialMessage);

// Add menu options from template
const menuOptions = supportMenuTemplate.cloneNode(true);
menuOptions.id = 'support-menu-options'; 
menuOptions.style.display = 'block';
supportBody.appendChild(menuOptions);

supportContentArea.style.display = 'none';
},

// Handles selections from the support menu (FIXED: Corrected panel display logic (P3))
handleMenuSelection: function(selection, buttonElement) {
supportBody.style.display = 'none';
supportContentArea.style.display = 'block';

// Hide all content panels explicitly
const panels = supportContentArea.querySelectorAll('.chat-info-panel');
panels.forEach(p => p.style.display = 'none');

// Show selected panel
if (selection === 'stats') {
document.getElementById('stat-max-streak').textContent = this.elements.highScore.textContent;
document.getElementById('statsPanelContent').style.display = 'block';
} else if (selection === 'faq') {
document.getElementById('faqPanelContent').style.display = 'block';
} else if (selection === 'lore') {
document.getElementById('lorePanelContent').style.display = 'block';
}
},

// Returns to the support main menu
returnToMainMenu: function() {
this.populateSupportModal(); // Repopulate the menu
supportBody.style.display = 'block';
supportContentArea.style.display = 'none';
},

// Reset high score only
resetHighScoreOnly: function() {
if (confirm("Are you sure you want to permanently erase your high score for this protocol? This cannot be undone.")) {
localStorage.removeItem(this.highScoreKey);
this.elements.highScore.textContent = '0';
document.getElementById('stat-max-streak').textContent = '0';
alert("High score wiped.");
this.restartGame(); // Force a clean restart
}
},
};

// --- GLOBAL EVENT HANDLERS & INITIAL CALLS ---

// Toggle Theme (used by the settings modal)
themeToggle.addEventListener('change', () => {
body.classList.toggle('light-mode');
stats.theme = body.classList.contains('light-mode') ? 'light' : 'dark';
colorSeq.saveStats();
});

// Toggle Sound (used by the settings modal)
soundToggle.addEventListener('change', () => {
stats.soundEnabled = soundToggle.checked;
colorSeq.saveStats();
});


// Instructions Modal Toggle
document.getElementById('infoBtn').addEventListener('click', () => {
instructionsBox.classList.toggle('visible');
});

// Settings Modal Toggle
function toggleSettingsModal() {
settingsModal.classList.toggle('visible');
supportModal.classList.remove('visible'); // Close support if open
}

function closeSettingsModal() {
settingsModal.classList.remove('visible');
}

// Support Modal Toggle
function toggleSupportModal() {
supportModal.classList.toggle('visible');
settingsModal.classList.remove('visible'); // Close settings if open
// Initialize the main menu every time the modal is opened
if (supportModal.classList.contains('visible')) {
    colorSeq.populateSupportModal();
}
}

function closeSupportModal() {
supportModal.classList.remove('visible');
}


// Function to clear all timers and effects on game end/restart
function clearTimersAndEffects() {
clearInterval(confettiInterval);
document.querySelectorAll(".confetti").forEach(c => c.remove());
document.getElementById("highScoreBanner").classList.remove('active');
document.getElementById("gameOverBanner").classList.remove('active');
}

// Confetti Effect
function startConfetti(duration) {
    clearInterval(confettiInterval); // Ensure no old interval is running
    // Use the core game colors for the confetti
    const colors = ["#f44336", "#4CAF50", "#2196F3", "#FFEB3B", "#9c27b0", "#00bcd4", "#ff5722", "#009688"]; 
    const count = 50;

    confettiInterval = setInterval(() => {
        if (document.querySelectorAll(".confetti").length < count) {
            for (let i = 0; i < 5; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.width = (Math.random() * 8 + 5) + 'px';
                confetti.style.height = (Math.random() * 8 + 5) + 'px';
                confetti.style.left = Math.random() * window.innerWidth + "px";
                
                // Corrected line for the confetti color
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; 
                
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), duration);
            }
        }
    }, 200);
    setTimeout(() => clearInterval(confettiInterval), duration + 500);
}


// Initial load
window.onload = function() {
colorSeq.loadStats();
// Ensure the correct difficulty is set up visually on load
colorSeq.setDifficulty(stats.difficulty);
};
</script>
</body>
</html>