<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess Master Protocol (GMP.html)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- Root Variables for Dark Mode (Default) --- */
        :root {
            --color-primary: #3f68a8;       /* Muted Blue */
            --color-secondary: #00bcd4;     /* Cyan Accent */
            --color-accent: #ff9800;        /* Gold/Orange Accent (Chat/Highlight) */
            --color-error: #f44336;
            --color-success: #8bc34a;
            --color-text: #e0e6f0;
            --box-background: rgba(25, 35, 55, 0.9);
            --modal-bg: #101a2e;
            --chat-bg: #0d162a; /* Darker background for chat messages */
            --modal-header: var(--color-accent);
        }
        /* --- Light Mode Overrides --- */
        body.light-mode {
            background: linear-gradient(135deg, #ffffff, #c7e0ff);
            color: #333;
            --color-primary: #5c7fa9;
            --color-secondary: #008c99;
            --color-accent: #e65100;
            --color-error: #c62828;
            --color-success: #4caf50;
            --color-text: #333;
            --box-background: rgba(255, 255, 255, 0.9);
            --modal-bg: #f5f8ff;
            --chat-bg: #ffffff;
            --modal-header: var(--color-accent);
        }

        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            
            /* --- REVISED: Dark Radial Gradient (Black Center, Dark Orange Glow) --- */
            /* Keeps the center black and fades to a dark orange on the edges for a deep, dark gaming look. */
            background: radial-gradient(circle at center, #000000 0%, #000000 45%, #6e3500 100%);
            /* ---------------------------------------------------------------------- */
            
            color: var(--color-text);
            overflow: hidden;
            transition: color 0.3s, background 0.3s;
        }
        
        /* --- BANNERS FIX: Ensure they are hidden by default --- */
        #highScoreBanner, #gameOverBanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 15px 0;
            background: var(--color-accent);
            color: var(--modal-bg);
            font-size: 20px;
            font-weight: 700;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.4s ease-out, background 0.4s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        #gameOverBanner {
            background: var(--color-error);
        }
        #highScoreBanner.active, #gameOverBanner.active {
            transform: translateY(0);
        }
        /* --- END BANNERS FIX --- */

        /* --- MAIN GAME BOX & STANDARD STYLES (INCREASED SIZE) --- */
        #game-box {
            background: var(--box-background);
            backdrop-filter: blur(18px);
            border-radius: 15px;
            border: 2px solid var(--color-secondary); 
            padding: 40px 50px; 
            width: 450px; 
            max-width: 90%;
            min-height: 550px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.7);
            text-align: center;
            position: relative;
            height: auto;
            /* Changed overflow to visible for absolute footer */
            overflow: visible; 
            transition: all 0.3s ease;
            z-index: 1;
        }

        /* --- FOOTER MOVED INSIDE GAME BOX --- */
        #footer {
            position: absolute;
            bottom: 0; /* Position at the bottom of the game-box */
            left: 0;
            width: 100%;
            padding: 5px 0;
            background: rgba(0, 0, 0, 0.3); /* Dark background for visibility */
            color: rgba(0, 188, 212, 0.7); /* Cyan/Secondary color */
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            border-top: 1px solid rgba(0, 188, 212, 0.2);
            box-sizing: border-box;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
            z-index: 5;
        }
        /* ------------------------------------- */

        h2 { 
            margin-bottom: 5px; 
            font-size: 26px; 
            font-weight: 700; 
            letter-spacing: 2px; 
            color: var(--color-text); 
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
        }
        #high-score-display-guessMaster { 
            font-size: 13px; 
            font-weight: 500; 
            margin-bottom: 25px; 
            color: var(--color-accent); 
            text-transform: uppercase; 
        }
        
        /* --- ELABORATE GAME BOX ELEMENTS --- */
        .control-panel, .input-area {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 188, 212, 0.3);
        }
        .panel-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: block;
        }
        .status-display {
            background: #1a2333; 
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 16px;
            color: var(--color-accent);
        }

        label { font-size: 14px; display: block; margin: 10px 0 8px; font-weight: 500; color: var(--color-text); opacity: 0.8; }
        
        input[type="number"] { padding: 14px; width: 85%; margin: 0 auto 15px; border-radius: 8px; border: none; outline: none; font-size: 24px; font-weight: 700;
        text-align: center; background: rgba(255, 255, 255, 0.05); color: var(--color-text); box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transition: all 0.2s ease;
        max-width: 250px; font-family: 'Share Tech Mono', monospace; }

        button { background: var(--color-primary); border: none; padding: 12px 22px; margin: 8px 6px; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 700;
        cursor: pointer; transition: 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-transform: uppercase; letter-spacing: 0.5px; min-width: 120px; border-bottom: 3px solid var(--color-secondary);
        }
        button:hover { background: #507aad; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.7); }
        #restartBtn { background: #616161; border-bottom: 3px solid #9e9e9e; }
        #restartBtn:hover { background: #757575; }
        .msg { padding: 12px; margin-top: 20px; border-radius: 6px; font-weight: 700; font-size: 15px; min-height: 20px; }
        
        /* --- FIXED BUTTONS (Positioning Stacked Left/Right) --- */
        .fixed-btn { position: fixed; background: var(--color-primary); border: none; padding: 10px 18px; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600;
        cursor: pointer; transition: 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 101; margin: 0; text-transform: uppercase; border-bottom: 3px solid var(--color-secondary);
        }
        .fixed-btn:hover { transform: scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.5); }
        
        /* BACK TO INDEX (Top Left) */
        #indexBtn { top: 20px; left: 20px; right: auto; background: #607d8b; border-bottom: 3px solid #90a4ae; } 
        #indexBtn:hover { background: #78909c; }
        
        /* Info and History Buttons (Top Right Stack) */
        #infoBtn { top: 20px; right: 20px; }
        #historyBtn { top: 75px; right: 20px; background: var(--color-accent); border-bottom: 3px solid #ff5722; display: none; }
        
        /* --- FLOATING ICONS (Bottom Right) --- */
        .floating-icon { position: fixed; bottom: 20px; width: 50px; height: 50px; border-radius: 50%; color: white; line-height: 50px; text-align: center;
        cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.2s, background 0.2s; z-index: 150; font-size: 28px; border: 2px solid var(--color-secondary);
        }
        #settingsIcon { right: 20px; font-size: 28px; background: var(--color-secondary); border-color: var(--color-secondary); color: var(--modal-bg); }
        #supportIcon { right: 90px; font-size: 24px; background: var(--color-accent); border-color: var(--color-accent); color: var(--modal-bg); }
        .floating-icon:hover { transform: scale(1.1) rotate(5deg); }
        
        /* --- FIXED PANELS --- */
        .fixed-panel-common { position: fixed; right: 20px; width: 300px; background: var(--modal-bg); border-radius: 10px; padding: 0; text-align: left;
        font-size: 14px; line-height: 1.6; color: var(--color-text); z-index: 210; opacity: 0; visibility: hidden; transition: 0.3s ease; transform: scale(0.9); transform-origin: top right; 
        border: 2px solid var(--color-secondary); box-shadow: 0 10px 30px rgba(0,0,0,0.9); display: flex; flex-direction: column; }
        .fixed-panel-common.visible { opacity: 1; visibility: visible; transform: scale(1); }
        
        /* Adjusted Panel Positions */
        #instructions { top: 75px; max-height: 80vh; overflow-y: hidden; } 
        #historyPanel { top: 130px; max-height: 400px; padding: 15px; border-left: 3px solid var(--color-accent); overflow-y: auto; } 
        
        /* Chat/Modal Headers (Standard) */
        .modal-header, .chat-header {
            padding: 10px 15px; background: var(--color-primary); color: var(--color-accent); font-weight: 700; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--color-accent);
            flex-shrink: 0;
        }
        .modal-close-btn { background: transparent; border: none; color: var(--color-accent); font-size: 20px; cursor: pointer; padding: 5px; line-height: 1; margin-right: -5px; transition: color 0.1s; }
        .modal-close-btn:hover { color: var(--color-secondary); }

        /* --- CHAT/SUPPORT STYLES --- */
        #chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; background: var(--chat-bg); color: var(--color-text); max-height: 300px; }
        .chat-message { margin-bottom: 12px; padding: 8px 12px; border-radius: 8px; font-size: 13px; line-height: 1.4; max-width: 80%; }
        .chat-system { background: rgba(0, 188, 212, 0.1); color: var(--color-secondary); margin-right: auto; border: 1px solid var(--color-secondary); text-align: left; }
        .chat-user { background: var(--color-primary); color: var(--color-text); margin-left: auto; text-align: right; }
        #chat-menu-area { display: flex; flex-direction: column; padding: 10px 15px; gap: 8px; border-top: 1px solid rgba(0, 188, 212, 0.2); background: var(--chat-bg); flex-shrink: 0; }
        .chat-option-btn { background: var(--color-primary); color: var(--color-text); border: 1px solid var(--color-accent); padding: 10px; border-radius: 5px; cursor: pointer; text-align: left;
        font-family: 'Montserrat', sans-serif; font-size: 13px; font-weight: 500; transition: background 0.1s, box-shadow 0.2s; }
        .chat-option-btn:hover { background: #507aad; box-shadow: 0 0 8px var(--color-accent); }

        /* Floating Modals positioning for chat/settings */
        #settingsModal { bottom: 80px; right: 20px; transform-origin: bottom right; }
        #supportModal { bottom: 80px; right: 90px; transform-origin: bottom right; }
        .floating-modal { width: 300px; background: var(--modal-bg); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.7); z-index: 200; transform: scale(0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; position: fixed;}
        .floating-modal.visible { transform: scale(1); opacity: 1; visibility: visible; }
    </style>
</head>
<body class="dark-mode">

    <div id="highScoreBanner">New High Score Unlocked! 🏅 </div>
    <div id="gameOverBanner"> ❌ PROTOCOL FAILURE ❌ </div>

    <button id="indexBtn" class="fixed-btn" onclick="goToIndex()"> 🏠 BACK TO INDEX</button> 
    
    <button id="infoBtn" class="fixed-btn">Protocol | RULES</button>
    <button id="historyBtn" class="fixed-btn"> 📊 VIEW LOG</button>

    <div id="settingsIcon" class="floating-icon" onclick="toggleExclusivePanel(settingsModal)"> ⚙️ </div>
    <div id="supportIcon" class="floating-icon" onclick="toggleExclusivePanel(supportModal)"> 💬 </div>

    <div id="supportModal" class="fixed-panel-common floating-modal">
        <div class="chat-header">
            AI ASSISTANT: PROTOCOL SUPPORT
            <button class="modal-close-btn" onclick="toggleExclusivePanel(supportModal)"> ✕ </button>
        </div>
        <div id="chat-messages">
            </div>
        <div id="chat-menu-area">
            </div>
    </div>
    
    <div id="instructions" class="fixed-panel-common">
        <div class="modal-header">
            PROTOCOL GUIDELINES
            <button class="modal-close-btn" onclick="toggleExclusivePanel(instructions)"> ✕ </button>
        </div>
        <div class="modal-body">
            <h4 id="rules-title">DECRYPTION PROCEDURE</h4>
            <div id="rules-content">
            </div>
        </div>
    </div>

    <div id="historyPanel" class="fixed-panel-common">
        <div class="modal-header">
            GUESS LOG
            <button class="modal-close-btn" onclick="toggleExclusivePanel(historyPanel)"> ✕ </button>
        </div>
        <div class="modal-body">
            <div id="guesses-list">No attempts logged yet.</div>
        </div>
    </div>
    
    <div id="settingsModal" class="fixed-panel-common floating-modal">
        <div class="modal-header">
            SYSTEM SETTINGS
            <button class="modal-close-btn" onclick="toggleExclusivePanel(settingsModal)"> ✕ </button>
        </div>
        <div class="modal-body">
            <h4>INTERFACE PREFERENCES</h4>
            <div class="setting-row">
                <label for="themeToggle">Light Mode</label>
                <input type="checkbox" id="themeToggle">
            </div>
            <div class="setting-row">
                <label for="soundToggle">Sound Effects</label>
                <input type="checkbox" id="soundToggle">
            </div>
        </div>
    </div>
    
    <div id="game-box">

        <div id="guessMaster">
            <h2> 🔬 GUESS MASTER PROTOCOL</h2>

            <p id="high-score-display-guessMaster"> 🏅 BEST SCORE: N/A</p>

            <div id="game-container">
                <div id="pre-game-setup">
                    <div class="control-panel">
                        <span class="panel-label">PROTOCOL CONFIGURATION</span>
                        
                        <label for="maxGuesses">SET DECRYPTION ATTEMPTS (1-20):</label>
                        <input type="number" id="maxGuesses" min="1" max="20" placeholder="7" value="7" style="font-size: 18px; margin-bottom: 5px;">
                        
                        <div class="setting-row" style="margin: 10px auto 5px auto; border-bottom: none;">
                            <label for="inverseToggle" style="margin: 0;"> 🔄 INVERSE FEEDBACK MODE</label>
                            <input type="checkbox" id="inverseToggle">
                        </div>
                    </div>
                    
                    <button id="startBtn" onclick="guessMaster.startGame()"> ▶️ ACTIVATE PROTOCOL</button>
                </div>

                <div id="game" style="display:none;">
                    
                    <div class="status-display">
                        <span style="color: var(--color-secondary);">ATTEMPT STATUS: </span>
                        <span id="attempt" style="color: var(--color-accent); font-size: 28px;">0</span> / 
                        <span id="max" style="color: var(--color-secondary); font-size: 20px;"></span>
                    </div>

                    <div class="input-area">
                        <span class="panel-label">INPUT SECRET CODE</span>
                        <input type="number" id="guess" placeholder="CODE (1-100)">

                        <button id="submitBtn" onclick="guessMaster.checkGuess()"> ✔️ SUBMIT CODE</button>
                        <button id="restartBtn" onclick="guessMaster.restartGame()">RESET PROTOCOL</button>
                    </div>

                    <div class="msg" id="message"></div>
                </div>
            </div>
        </div>
        
        <div id="footer">
            Developed & Branded by Aarav Sinha
        </div>
        
    </div>

    <script>
        // --- GLOBAL STATE & UTILITIES ---
        let confettiInterval;
        let redirectTimer;

        let stats = {
            gamesPlayed: 0,
            wins: 0,
            winStreak: 0,
            longestStreak: 0,
            soundEnabled: true,
            theme: 'dark',
        };
        const body = document.body;
        const instructionsBox = document.getElementById("instructions");
        const historyPanel = document.getElementById("historyPanel");
        const settingsModal = document.getElementById("settingsModal");
        const supportModal = document.getElementById("supportModal");

        const soundToggle = document.getElementById('soundToggle');
        const themeToggle = document.getElementById('themeToggle');
        const rulesContent = document.getElementById('rules-content');
        const guessesList = document.getElementById('guesses-list');
        
        // Array of all panels for easy iteration
        const allPanels = [instructionsBox, historyPanel, settingsModal, supportModal];

        // --- GAME LOGIC: GUESS MASTER PROTOCOL (1-100) ---
        const guessMaster = {
            name: 'guessMaster',
            randomNumber: null,
            attempts: 0,
            maxAttempts: 7,
            gameActive: false,
            inverseModeActive: false,
            highScoreKey: 'guessMasterHighScore',

            elements: {
                display: document.getElementById("high-score-display-guessMaster"),
                message: document.getElementById("message"),
                maxGuesses: document.getElementById("maxGuesses"),
                inverseToggle: document.getElementById("inverseToggle"),
                startBtn: document.getElementById("startBtn"),
                gameDiv: document.getElementById("game"),
                attemptSpan: document.getElementById("attempt"),
                maxSpan: document.getElementById("max"),
                guessInput: document.getElementById("guess"),
                submitBtn: document.getElementById("submitBtn"),
                preGameSetup: document.getElementById("pre-game-setup"),
            },

            ruleContent: `
            <p>Your objective is to deduce the **secret 2-digit number** (1 to 100) generated by the central system.</p>
            <ul>
                <li>**Difficulty:** Set the number of attempts (1-20) before activation.</li>
                <li>**Inverse Mode:** Reverses the "HIGH/LOW" directional hints (Advanced).</li>
                <li>**Feedback Loop:** The system provides real-time feedback (Too High/Low, Almost) to guide your next input.</li>
                <li>**Goal:** Achieve the lowest score (fewest attempts) possible.</li>
            </ul>
            `,
            loadHighScore() {
                const bestScore = localStorage.getItem(this.highScoreKey);
                this.elements.display.innerText = bestScore ? ` 🏅 BEST SCORE: ${bestScore} GUESSES` : ` 🏅 BEST SCORE: N/A`;
            },
            saveHighScore() {
                const currentHighScore = parseInt(localStorage.getItem(this.highScoreKey)) || Infinity;
                if (this.attempts < currentHighScore) {
                    localStorage.setItem(this.highScoreKey, this.attempts);
                    this.loadHighScore();
                    showBanner("highScoreBanner");
                }
            },

            startGame() {
                clearTimersAndEffects();
                this.randomNumber = Math.floor(Math.random() * 100) + 1;
                this.attempts = 0;
                this.gameActive = true;
                this.maxAttempts = parseInt(this.elements.maxGuesses.value);
                this.inverseModeActive = this.elements.inverseToggle.checked;

                this.elements.gameDiv.style.display = "block";
                this.elements.preGameSetup.style.display = "none";
                this.elements.maxGuesses.setAttribute("disabled", true);
                this.elements.inverseToggle.setAttribute("disabled", true);

                this.elements.maxSpan.innerText = this.maxAttempts;
                this.elements.attemptSpan.innerText = this.attempts;
                this.elements.message.innerText = " 🎮 Protocol Activated. Awaiting first input...";
                this.elements.message.className = 'msg';
                this.elements.guessInput.value = "";
                this.elements.guessInput.focus();
                document.getElementById('historyBtn').style.display = 'inline-block'; // Show history
                guessesList.innerHTML = "";
                stats.gamesPlayed++;
                saveStats();
            },

            checkGuess() {
                if (!this.gameActive) return;

                const guess = parseInt(this.elements.guessInput.value);
                this.elements.guessInput.value = "";
                this.elements.guessInput.focus();

                if (isNaN(guess) || guess < 1 || guess > 100) {
                    this.elements.message.innerText = " ⚠️ ERROR: Input must be a number between 1 and 100.";
                    this.elements.message.className = 'msg error';
                    return;
                }

                this.attempts++;
                this.elements.attemptSpan.innerText = this.attempts;
                let messageText = '';
                let messageClass = 'msg';

                const logEntry = document.createElement('div');
                logEntry.className = 'history-entry';

                if (guess === this.randomNumber) {
                    // WIN CONDITION
                    this.endGame(true);
                    messageText = ` 🎉 SUCCESS! Code breached in ${this.attempts} attempts. Target: ${this.randomNumber}!`;
                    messageClass += ' win';
                    logEntry.innerHTML = `Attempt ${this.attempts}: **${guess}** -> <span style="color:var(--color-success)">CODE BREACHED!</span>`;
                    
                    stats.wins++;
                    stats.winStreak++;
                    if (stats.winStreak > stats.longestStreak) {
                        stats.longestStreak = stats.winStreak;
                    }

                } else if (this.attempts >= this.maxAttempts) {
                    // LOSE CONDITION
                    this.endGame(false);
                    messageText = ` ❌ FAILURE! Attempts exhausted. The secret code was ${this.randomNumber}.`;
                    messageClass += ' lose';
                    logEntry.innerHTML = `Attempt ${this.attempts}: **${guess}** -> <span style="color:var(--color-error)">LAST ATTEMPT, FAILURE.</span>`;

                    stats.winStreak = 0;

                } else {
                    // HINT FEEDBACK
                    const difference = Math.abs(guess - this.randomNumber);
                    let direction = (guess > this.randomNumber) ? 'HIGH' : 'LOW';

                    // Apply Inverse Feedback Mode if active
                    if (this.inverseModeActive) {
                        direction = (direction === 'HIGH') ? 'LOW' : 'HIGH';
                    }

                    if (direction === 'HIGH') {
                        messageText = ' ⬇️ Code Too HIGH.';
                        messageClass += ' high';
                    } else {
                        messageText = ' ⬆️ Code Too LOW.';
                        messageClass += ' low';
                    }
                    
                    if (difference <= 5) {
                        messageText = ' 🎯 Code ALMOST BREACHED (Proximal Target).';
                        messageClass += ' almost';
                    }

                    logEntry.innerHTML = `Attempt ${this.attempts}: **${guess}** -> ${direction} ${difference <= 5 ? '(Proximal)' : ''}`;
                }

                // Update UI and Log
                this.elements.message.innerText = messageText;
                this.elements.message.className = messageClass;
                guessesList.prepend(logEntry);
                saveStats();
            },

            restartGame() {
                clearTimersAndEffects();
                this.gameActive = false;
                this.elements.gameDiv.style.display = "none";
                this.elements.preGameSetup.style.display = "block";
                this.elements.maxGuesses.removeAttribute("disabled");
                this.elements.inverseToggle.removeAttribute("disabled");
                this.elements.message.innerText = " ✅ Protocol Reset. Configure attempts to reactivate.";
                this.elements.message.className = 'msg win';
                this.loadHighScore();
                document.getElementById('historyBtn').style.display = 'none'; // Hide history
            },
            
            endGame(isWin) {
                this.gameActive = false;
                this.elements.submitBtn.setAttribute('disabled', true);
                
                if (isWin) {
                    this.saveHighScore();
                    spawnConfetti(5000);
                } else {
                    showBanner("gameOverBanner");
                }

                // Redirect logic for game completion
                startRedirectTimer(() => {
                    this.elements.submitBtn.removeAttribute('disabled');
                    this.restartGame();
                });
            }
        };

        // --- CORE UI/EFFECT FUNCTIONS ---

        function showBanner(id) {
            hideBanner("highScoreBanner");
            hideBanner("gameOverBanner");
            document.getElementById(id).classList.add('active');
        }
        function hideBanner(id) {
            document.getElementById(id).classList.remove('active');
        }

        function spawnConfetti(duration) {
            if (!stats.soundEnabled) return;
            confettiInterval = setInterval(() => {
                for (let i = 0; i < 5; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.left = Math.random() * window.innerWidth + "px";
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), duration); 
                }
            }, 200);
            setTimeout(() => clearInterval(confettiInterval), duration + 500);
        }
        
        function clearTimersAndEffects() {
            clearInterval(confettiInterval);
            clearInterval(redirectTimer);
            document.querySelectorAll(".confetti").forEach(c => c.remove());
            hideBanner("highScoreBanner");
            hideBanner("gameOverBanner");
        }

        function startRedirectTimer(callback) {
            let timeLeft = 5;
            const countdownSpan = document.createElement('span');
            countdownSpan.id = 'countdown';
            
            countdownSpan.innerText = ` (Redirecting in ${timeLeft}s...)`;
            guessMaster.elements.message.appendChild(countdownSpan);
            redirectTimer = setInterval(() => {
                timeLeft--;
                countdownSpan.innerText = ` (Redirecting in ${timeLeft}s...)`;
                if (timeLeft <= 0) {
                    clearInterval(redirectTimer);
                    callback();
                }
            }, 1000);
        }

        // --- NAVIGATION & MODAL FUNCTIONS ---

        function goToIndex() {
            window.location.href = 'index.html';
        }
        
        /**
         * Toggles a panel, ensuring only one panel is open at a time (Precision Stop Style).
         * @param {HTMLElement} panelToOpen - The DOM element of the panel to be toggled.
         */
        function toggleExclusivePanel(panelToOpen) {
            const isPanelCurrentlyOpen = panelToOpen.classList.contains('visible');
            
            // Close all panels first
            allPanels.forEach(panel => {
                if (panel.classList.contains('visible')) {
                    panel.classList.remove('visible');
                }
            });

            // If the panel was not open, open it now
            if (!isPanelCurrentlyOpen) {
                panelToOpen.classList.add('visible');
                
                // Special case: initialize chat menu if opening the support modal
                if (panelToOpen === supportModal) {
                    initializeChat();
                }
            }
        }


        // --- CHAT SYSTEM LOGIC (Precision Stop Style) ---
        const chatMessages = document.getElementById('chat-messages');
        const chatMenuArea = document.getElementById('chat-menu-area');

        const responseDatabase = {
            'INITIAL': {
                system: "Welcome to AI ASSISTANT. How may I assist you with the Guess Master Protocol?",
                options: [
                    { text: "Check Protocol Metrics (Stats)", next: "STATS" },
                    { text: "Review Support FAQ", next: "FAQ" },
                    { text: "Read Mission Briefing (Lore)", next: "LORE" },
                    { text: "Nevermind, close support.", next: "CLOSE" }
                ]
            },
            'STATS': {
                system: () => {
                    updateStatsDisplay();
                    const winRate = stats.gamesPlayed > 0 ? ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) : 0;
                    return `**PROTOCOL METRICS:**
                    - Games Played: ${stats.gamesPlayed}
                    - Total Wins: ${stats.wins}
                    - Win Rate: ${winRate}%
                    - Longest Streak: ${stats.longestStreak}`;
                },
                options: [
                    { text: "Reset High Score Only", next: "RESET_HIGH_SCORE" },
                    { text: "WIPE ALL DATA", next: "WIPE_ALL_DATA" },
                    { text: "Back to Main Menu", next: "INITIAL" }
                ]
            },
            'FAQ': {
                system: `**SUPPORT FAQ:**
                Q: What is "Inverse Feedback Mode"?
                A: It reverses the "HIGH/LOW" directional hints, requiring advanced deduction.

                Q: How is the High Score tracked?
                A: The High Score tracks your **fewest guesses** (lowest number is best) to crack the code successfully.`,
                options: [
                    { text: "Back to Main Menu", next: "INITIAL" }
                ]
            },
            'LORE': {
                system: `**MISSION BRIEFING:**
                "You are a User. Guess Master is a live decryption simulation targeting a 2-digit code (1-100). Your goal is to breach the target before the attempt count is exhausted. Failure to adhere to the Attempt Status results in immediate system self-wipe. Good luck, User."`,
                options: [
                    { text: "Back to Main Menu", next: "INITIAL" }
                ]
            },
            'RESET_HIGH_SCORE': {
                system: "Are you sure you want to PERMANENTLY reset only the Best Score metric?",
                options: [
                    { text: "CONFIRM RESET", next: "CONFIRM_RESET_HIGH_SCORE" },
                    { text: "No, cancel.", next: "STATS" }
                ]
            },
            'CONFIRM_RESET_HIGH_SCORE': {
                system: () => {
                    localStorage.removeItem(guessMaster.highScoreKey);
                    guessMaster.loadHighScore();
                    return "High Score reset confirmed. Metric reset complete.";
                },
                options: [
                    { text: "Back to Main Menu", next: "INITIAL" }
                ]
            },
            'WIPE_ALL_DATA': {
                system: "WARNING: This will PERMANENTLY wipe ALL game data (Stats, Streaks, High Score). Confirm wipe?",
                options: [
                    { text: "CONFIRM WIPE (Critical Action)", next: "CONFIRM_WIPE_ALL_DATA" },
                    { text: "No, cancel.", next: "STATS" }
                ]
            },
            'CONFIRM_WIPE_ALL_DATA': {
                system: () => {
                    localStorage.removeItem('guessMasterStats');
                    localStorage.removeItem(guessMaster.highScoreKey);
                    stats = { gamesPlayed: 0, wins: 0, winStreak: 0, longestStreak: 0, soundEnabled: true, theme: 'dark' };
                    guessMaster.loadHighScore();
                    loadStats(); // Re-load to apply defaults
                    return "System data wipe complete. All metrics reset.";
                },
                options: [
                    { text: "Back to Main Menu", next: "INITIAL" }
                ]
            },
            'CLOSE': {
                system: "Closing support menu. Good luck with the protocol.",
                action: () => toggleExclusivePanel(supportModal) 
            }
        };

        function displayMessage(text, isUser = false) {
            const msg = document.createElement('div');
            msg.classList.add('chat-message', isUser ? 'chat-user' : 'chat-system');
            
            // Convert system text to HTML for line breaks
            if (!isUser) {
                msg.innerHTML = text.replace(/\n/g, '<br>');
            } else {
                msg.textContent = text;
            }
            
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayOptions(key) {
            const responseData = responseDatabase[key];
            chatMenuArea.innerHTML = ''; // Clear old options
            
            let systemText;
            if (typeof responseData.system === 'function') {
                systemText = responseData.system();
            } else {
                systemText = responseData.system;
            }
            
            displayMessage(systemText);

            if (responseData.options) {
                responseData.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.classList.add('chat-option-btn');
                    btn.textContent = option.text;
                    btn.onclick = () => handleChatOption(option.text, option.next);
                    chatMenuArea.appendChild(btn);
                });
            }
        }

        function handleChatOption(userText, nextKey) {
            displayMessage(userText, true);

            if (nextKey === 'CLOSE' && responseDatabase['CLOSE'].action) {
                displayMessage(responseDatabase['CLOSE'].system);
                setTimeout(() => {
                    responseDatabase['CLOSE'].action();
                }, 500);
                
                // Reset state for next open
                setTimeout(() => {
                    chatMessages.innerHTML = ''; 
                    displayOptions('INITIAL');
                }, 800);
                return;
            }
            
            setTimeout(() => {
                displayOptions(nextKey);
            }, 500);
        }

        function initializeChat() {
            chatMessages.innerHTML = ''; 
            displayOptions('INITIAL');
        }

        // --- STATS/STORAGE LOGIC ---
        function loadStats() {
            const savedStats = localStorage.getItem('guessMasterStats');
            if (savedStats) {
                stats = JSON.parse(savedStats);
            }
            // Apply theme/sound settings immediately
            body.className = stats.theme + '-mode';
            themeToggle.checked = stats.theme === 'light';
            soundToggle.checked = stats.soundEnabled;
        }
        function saveStats() {
            localStorage.setItem('guessMasterStats', JSON.stringify(stats));
        }
        function updateStatsDisplay() {
            // Stats are dynamically generated in the responseDatabase function
        }


        // --- EVENT LISTENERS & INITIALIZATION ---
        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                stats.theme = 'light';
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                stats.theme = 'dark';
            }
            saveStats();
        });
        soundToggle.addEventListener('change', () => {
            stats.soundEnabled = soundToggle.checked;
            saveStats();
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            guessMaster.loadHighScore();
            rulesContent.innerHTML = guessMaster.ruleContent;
            document.getElementById('historyBtn').style.display = 'none'; // Hide history on load
            
            // Initializing banner state (Ensures they are visually hidden on load)
            hideBanner("highScoreBanner");
            hideBanner("gameOverBanner");
        });
    </script>
</body>
</html>
