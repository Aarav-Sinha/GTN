<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess Master Protocol (GMP.html)</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Root Variables for Dark Mode (Default) --- */
        :root {
            --color-primary: #3f68a8;       /* Muted Blue */
            --color-secondary: #00bcd4;     /* Cyan Accent */
            --color-accent: #ff9800;        /* Gold/Orange Accent */
            --color-error: #f44336;
            --color-success: #8bc34a;
            --color-text: #e0e6f0;
            --box-background: rgba(25, 35, 55, 0.9); 
            --modal-bg: #101a2e; 
            --modal-header: var(--color-accent); 
        }

        /* --- Light Mode Overrides --- */
        body.light-mode {
            background: linear-gradient(135deg, #ffffff, #c7e0ff, #ffffff); 
            background-size: 400% 400%;
            color: #333; 

            --color-primary: #5c7fa9;       
            --color-secondary: #008c99;     
            --color-accent: #e65100;        
            --color-error: #c62828;
            --color-success: #4caf50;
            --color-text: #333;
            --box-background: rgba(255, 255, 255, 0.9); 
            --modal-bg: #f5f8ff; 
            --modal-header: var(--color-accent);
        }
        
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #1f4037, #991c49, #4a00e0, #2b32b2);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--color-text);
            overflow: hidden; 
            transition: color 0.3s, background 0.3s;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- HIGH SCORE & GAME OVER BANNERS --- */
        #highScoreBanner, #gameOverBanner {
            position: fixed; top: 0; left: 50%; transform: translateX(-50%) translateY(-100%);
            color: white; padding: 10px 20px; border-radius: 0 0 10px 10px;
            font-size: 16px; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 200;
            opacity: 0; visibility: hidden; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            letter-spacing: 1px;
        }
        #highScoreBanner {
            background: var(--color-success); 
            border-bottom: 5px solid #388e3c; 
        }
        #gameOverBanner {
            background: var(--color-error); 
            border-bottom: 5px solid #b71c1c; 
        }
        
        #highScoreBanner.active, #gameOverBanner.active { 
            transform: translateX(-50%) translateY(0); 
            opacity: 1; visibility: visible; 
        }

        /* --- CONFETTI STYLES --- */
        .confetti {
            position: fixed; top: -10px; width: 10px; height: 10px;
            transform: rotate(45deg); opacity: 0;
            animation: fall 2.5s ease-out forwards;
            z-index: 10;
        }

        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(45deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(500deg); opacity: 0; }
        }


        /* --- MAIN GAME BOX & STANDARD STYLES --- */
        #game-box {
            background: var(--box-background);
            backdrop-filter: blur(18px); 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 35px 45px;
            width: 350px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.7); 
            text-align: center;
            position: relative; 
            height: auto; 
            overflow: hidden; 
            transition: all 0.3s ease;
            z-index: 1; 
        }
        
        h2 { margin-bottom: 5px; font-size: 26px; font-weight: 700; letter-spacing: 2px; color: var(--color-text); text-shadow: 0 0 10px rgba(0, 188, 212, 0.5); }
        body.light-mode h2 { text-shadow: none; color: var(--color-primary); }
        #high-score-display-guessMaster { font-size: 13px; font-weight: 500; margin-bottom: 30px; color: var(--color-secondary); text-transform: uppercase; }
        label { font-size: 14px; display: block; margin: 18px 0 10px; font-weight: 500; color: var(--color-text); opacity: 0.8; }
        input[type="number"] { padding: 14px; width: 85%; margin: 0 auto 25px; border-radius: 8px; border: none; outline: none; font-size: 18px; font-weight: 700; text-align: center; background: rgba(255, 255, 255, 0.05); color: var(--color-text); box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); transition: all 0.2s ease; max-width: 250px; }
        
        button { background: var(--color-primary); border: none; padding: 12px 22px; margin: 8px 6px; border-radius: 8px; color: #fff; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.5); text-transform: uppercase; letter-spacing: 0.5px; min-width: 120px; border-bottom: 3px solid var(--color-secondary); }
        button:hover { background: #507aad; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.7); }
        #restartBtn { background: #616161; border-bottom: 3px solid #9e9e9e; }
        #restartBtn:hover { background: #757575; }

        .msg { padding: 12px; margin-top: 20px; border-radius: 6px; font-weight: 700; font-size: 15px; min-height: 20px; }
        .msg.win { background: var(--color-success); color: #fff; }
        .msg.lose { background: var(--color-error); color: #fff; }
        .msg.almost { background: var(--color-accent); color: #333; }
        .msg.high { background: rgba(255, 255, 255, 0.1); color: var(--color-text); }
        .msg.low { background: rgba(0, 0, 0, 0.1); color: var(--color-text); }
        .msg.error { background: var(--color-error); color: #fff; }

        .fixed-btn { position: fixed; background: var(--color-primary); border: none; padding: 10px 18px; border-radius: 8px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 101; margin: 0; text-transform: uppercase; border-bottom: 3px solid var(--color-secondary); }
        #infoBtn { top: 20px; right: 20px; } 
        #historyBtn { top: 75px; right: 20px; background: var(--color-accent); border-bottom: 3px solid #ff5722; display: none; }
        .fixed-btn:hover { transform: scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.5); }

        .floating-icon { position: fixed; bottom: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--modal-bg); color: white; line-height: 50px; text-align: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.2s, background 0.2s; z-index: 150; font-size: 28px; border: 2px solid var(--color-secondary); }
        #settingsIcon { right: 20px; font-size: 28px; }
        #supportIcon { right: 80px; font-size: 24px; background: var(--color-primary); border: 2px solid var(--color-primary); }
        .floating-icon:hover { transform: scale(1.1) rotate(5deg); }


        .fixed-panel-common { position: fixed; right: 20px; width: 300px; background: rgba(0, 0, 0, 0.9); border-radius: 10px; padding: 20px; text-align: left; font-size: 14px; line-height: 1.6; color: var(--color-text); z-index: 100; opacity: 0; visibility: hidden; transition: 0.3s ease; transform: translateX(100%); }
        .fixed-panel-common.visible { opacity: 1; visibility: visible; transform: translateX(0); }
        #instructions { top: 75px; border-left: 3px solid var(--color-secondary); max-height: 500px; overflow-y: auto; padding-bottom: 10px; }
        #historyPanel { top: 130px; max-height: 350px; padding: 15px; border-left: 3px solid var(--color-accent); overflow-y: auto; }
        .history-entry { background: rgba(255, 255, 255, 0.05); padding: 8px; margin-bottom: 5px; border-radius: 4px; }
        
        .floating-modal { position: fixed; bottom: 80px; right: 20px; width: 300px; background: var(--modal-bg); border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.7); z-index: 200; transform: scale(0.5); opacity: 0; visibility: hidden; transition: all 0.3s ease; transform-origin: bottom right; }
        .floating-modal.visible { transform: scale(1); opacity: 1; visibility: visible; }
        .modal-header { background: var(--color-primary); color: white; padding: 10px 15px; border-radius: 10px 10px 0 0; font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .chat-close-btn { background: transparent; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0; min-width: auto; box-shadow: none; margin: 0; border-bottom: none; }
        .modal-body { padding: 15px; max-height: 350px; overflow-y: auto; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.1); }
        .chat-message { padding: 8px; margin-bottom: 10px; border-radius: 8px; line-height: 1.4; }
        .ai-message { background: rgba(0, 188, 212, 0.1); color: var(--color-text); }
        .chat-option-btn { background: var(--color-secondary); color: var(--modal-bg); font-size: 13px; font-weight: 700; width: 100%; margin: 5px 0; border-bottom: 3px solid #0097a7; }
        .chat-info-panel { padding: 10px; border: 1px solid var(--color-accent); border-radius: 8px; margin-top: 10px; }

        /* --- FOOTER CREDIT TEXT --- */
        #footer { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 12px; color: rgba(255, 255, 255, 0.5); text-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 5; }
    </style>
</head>
<body class="dark-mode">
    
    <div id="highScoreBanner">New High Score Unlocked! üèÖ</div>
    <div id="gameOverBanner">‚ùå PROTOCOL FAILURE ‚ùå</div>

    <button id="infoBtn" class="fixed-btn">Protocol | RULES</button>
    <button id="historyBtn" class="fixed-btn">üìä VIEW LOG</button>
    
    <div id="settingsIcon" class="floating-icon" onclick="toggleSettingsModal()">‚öôÔ∏è</div>
    <div id="supportIcon" class="floating-icon" onclick="toggleSupportModal()">üí¨</div>
    
    
    <div id="instructions" class="fixed-panel-common">
        <h4 id="rules-title">PROTOCOL GUIDELINES</h4>
        <div id="rules-content">
            </div>
        <hr style="border-color: rgba(255,255,255,0.2); margin-top: 15px;">
        <small style="display: block; text-align: center; color: var(--color-text);">System developed by **Aarav Sinha**</small>
    </div>

    <div id="historyPanel" class="fixed-panel-common">
        <h3 id="history-title">GUESS LOG</h3>
        <div id="guesses-list">No attempts logged yet.</div>
    </div>


    <div id="settingsModal" class="floating-modal">
        <div class="modal-header">
            <span>‚öôÔ∏è SYSTEM SETTINGS</span>
            <button class="chat-close-btn" onclick="closeSettingsModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <h4>INTERFACE PREFERENCES</h4>
            <div class="setting-row">
                <label for="themeToggle">Light Mode</label>
                <input type="checkbox" id="themeToggle">
            </div>
            <div class="setting-row">
                <label for="soundToggle">Sound Effects</label>
                <input type="checkbox" id="soundToggle">
            </div>
        </div>
    </div>
    
    <div id="supportModal" class="floating-modal">
        <div class="modal-header">
            <span>üí¨ AI Assistant: Protocol Support</span>
            <button class="chat-close-btn" onclick="closeSupportModal()">‚úï</button>
        </div>
        <div id="supportBody" class="modal-body">
            </div>
        
        <div id="support-menu-options-template" style="display:none;">
            <button class="chat-option-btn" onclick="handleMenuSelection('stats', this)">üìà Check Protocol Metrics (Stats)</button>
            <button class="chat-option-btn" onclick="handleMenuSelection('faq', this)">‚ùì Review Support FAQ</button>
            <button class="chat-option-btn" onclick="handleMenuSelection('lore', this)">üåê Read Mission Briefing (Lore)</button>
        </div>
        
        <div id="supportContentArea" style="display: none;">
            <div id="statsPanelContent" class="chat-info-panel">
                <h4>PROTOCOL METRICS</h4>
                <p>Games Played: <span id="stat-games">0</span></p>
                <p>Total Wins: <span id="stat-wins">0</span></p>
                <p>Win Rate: <span id="stat-winrate">0%</span></p>
                <p>Current Streak: <span id="stat-streak">0</span></p>
                <p>Longest Streak: <span id="stat-max-streak">0</span></p>
                <button onclick="resetHighScoreOnly()" style="background: var(--color-accent); margin-top: 15px; width: 100%;">RESET CURRENT HIGH SCORE</button>
                <button onclick="resetAllStats()" style="background: var(--color-error); margin-top: 8px; width: 100%;">WIPE ALL DATA</button>
                <button onclick="returnToMainMenu()" style="background: var(--color-primary); margin-top: 8px; width: 100%;">BACK TO MENU</button>
            </div>
            <div id="faqPanelContent" class="chat-info-panel">
                <h4>SUPPORT FAQ</h4>
                <p class="faq-q">Q: What is "Inverse Feedback Mode"?</p>
                <p class="faq-a">A: It reverses the "HIGH/LOW" directional hints, making the game significantly harder for experienced users.</p>
                <p class="faq-q">Q: How is the High Score calculated?</p>
                <p class="faq-a">A: The High Score tracks your **fewest guesses** to successfully crack the code. Lower is better!</p>
                <button onclick="returnToMainMenu()" style="background: var(--color-primary); margin-top: 8px; width: 100%;">BACK TO MENU</button>
            </div>
            <div id="lorePanelContent" class="chat-info-panel">
                <h4>MISSION BRIEFING</h4>
                <p style="font-style: italic;">"You are a User. Guess Master is a live decryption simulation targeting a 2-digit code. Your goal is to breach the target before the attempt count is exhausted. Failure to adhere to the Attempt Status results in immediate system self-wipe."</p>
                <button onclick="returnToMainMenu()" style="background: var(--color-primary); margin-top: 8px; width: 100%;">BACK TO MENU</button>
            </div>
        </div>
    </div>


    <div id="game-box">
        
        <div id="guessMaster">
            <h2>üî¨ Guess Master</h2>
            
            <p id="high-score-display-guessMaster">üèÖ BEST SCORE: N/A</p>
            
            <div> 
                <label for="maxGuesses">Set Attempts (1 to 20):</label>
                <input type="number" id="maxGuesses" min="1" max="20" placeholder="E.g., 7" value="7">

                <div class="setting-row" style="margin: 5px auto 25px auto; max-width: 300px; border-bottom: none;">
                    <label for="inverseToggle" style="margin-bottom: 0;">üîÑ Inverse Feedback Mode (Advanced)</label>
                    <input type="checkbox" id="inverseToggle">
                </div>
                
                <button id="startBtn" onclick="guessMaster.startGame()">‚ñ∂Ô∏è ACTIVATE PROTOCOL</button>
                
                <div id="game" style="display:none;">
                    <p><b>Attempt Status:</b> <span id="attempt">0</span> / <span id="max"></span></p>
                    
                    <label for="guess">Enter Secret Code (1-100):</label>
                    <input type="number" id="guess" placeholder="Your Guess">
                    
                    <button id="submitBtn" onclick="guessMaster.checkGuess()">‚úîÔ∏è SUBMIT CODE</button>
                    <button id="restartBtn" onclick="guessMaster.restartGame()">RESET</button>
                    
                    <div class="msg" id="message"></div>
                </div>
            </div> 
        </div>

    </div>
    
    <div id="footer">
        Developed & Branded by Aarav Sinha
    </div>

    <script>
        // --- GLOBAL STATE & UTILITIES ---
        let confettiInterval;
        let redirectTimer; 
        let chatHistory = []; 
        
        let stats = {
            gamesPlayed: 0,
            wins: 0,
            winStreak: 0,
            longestStreak: 0,
            soundEnabled: true,
            theme: 'dark',
        };

        const body = document.body;
        const instructionsBox = document.getElementById("instructions");
        const historyPanel = document.getElementById("historyPanel");
        const infoButton = document.getElementById("infoBtn");
        const historyButton = document.getElementById("historyBtn");
        const settingsModal = document.getElementById("settingsModal");
        const supportModal = document.getElementById("supportModal");
        const soundToggle = document.getElementById('soundToggle');
        const themeToggle = document.getElementById('themeToggle');
        const rulesTitle = document.getElementById('rules-title');
        const rulesContent = document.getElementById('rules-content');
        const historyTitle = document.getElementById('history-title');
        const guessesList = document.getElementById('guesses-list');
        const supportBody = document.getElementById('supportBody');
        const supportMenuTemplate = document.getElementById('support-menu-options-template');
        const supportContentArea = document.getElementById('supportContentArea');


        // --- GAME LOGIC: GUESS MASTER PROTOCOL (1-100) ---
        const guessMaster = {
            name: 'guessMaster',
            randomNumber: null,
            attempts: 0,
            maxAttempts: 7,
            gameActive: false,
            inverseModeActive: false,
            highScoreKey: 'guessMasterHighScore',
            
            elements: {
                display: document.getElementById("high-score-display-guessMaster"),
                message: document.getElementById("message"),
                maxGuesses: document.getElementById("maxGuesses"),
                inverseToggle: document.getElementById("inverseToggle"),
                startBtn: document.getElementById("startBtn"),
                gameDiv: document.getElementById("game"),
                attemptSpan: document.getElementById("attempt"),
                maxSpan: document.getElementById("max"),
                guessInput: document.getElementById("guess"),
                submitBtn: document.getElementById("submitBtn"),
            },
            
            ruleContent: `
                <p>Your objective is to deduce the **secret 2-digit number** (1 to 100) generated by the central system.</p>
                <ul>
                    <li>**Difficulty:** Set the number of attempts (1-20) before activation.</li>
                    <li>**Inverse Mode:** Reverses the "HIGH/LOW" directional hints.</li>
                    <li>**Feedback Loop:** The system provides real-time feedback (Too High/Low, Almost) to guide your next input.</li>
                </ul>
            `,

            loadHighScore() {
                const bestScore = localStorage.getItem(this.highScoreKey);
                this.elements.display.innerText = bestScore ? `üèÖ BEST SCORE: ${bestScore} GUESSES` : `üèÖ BEST SCORE: N/A`;
            },
            
            startGame() {
                this.randomNumber = Math.floor(Math.random() * 100) + 1;
                this.attempts = 0;
                this.gameActive = true;
                this.maxAttempts = parseInt(this.elements.maxGuesses.value);
                this.inverseModeActive = this.elements.inverseToggle.checked;
                
                this.elements.gameDiv.style.display = "block";
                this.elements.startBtn.style.display = "none";
                this.elements.maxGuesses.setAttribute("disabled", true);
                this.elements.inverseToggle.setAttribute("disabled", true); 
                
                this.elements.maxSpan.innerText = this.maxAttempts;
                this.elements.attemptSpan.innerText = this.attempts;
                this.elements.message.innerText = "üéÆ Protocol Activated. Awaiting first input...";
                this.elements.message.className = 'msg';
                this.elements.guessInput.value = "";
                this.elements.guessInput.focus();

                showGameControls(true);
                guessesList.innerHTML = "No attempts logged yet.";
                stats.gamesPlayed++;
                saveStats();
            },
            
            checkGuess() {
                if (!this.gameActive) return;
                
                const guess = parseInt(this.elements.guessInput.value);
                this.elements.message.className = 'msg'; 

                if (isNaN(guess) || guess < 1 || guess > 100) {
                    this.elements.message.innerText = "‚ö†Ô∏è Input Error: Code must be between 1 and 100.";
                    this.elements.message.classList.add('error');
                    return;
                }

                this.attempts++;
                this.elements.attemptSpan.innerText = this.attempts;

                let colorClass = '';
                let hintText = '';
                let feedbackIcon = '';
                let gameEnded = false;
                let proximity = Math.abs(guess - this.randomNumber);

                if (guess === this.randomNumber) {
                    colorClass = 'win';
                    hintText = "SUCCESS!";
                    feedbackIcon = 'üèÜ';
                    this.elements.message.innerText = `‚úÖ SUCCESS! Target acquired in ${this.attempts} attempts. Mission complete.`;
                    gameEnded = true;
                    
                    stats.wins++;
                    stats.winStreak++;
                    if (stats.winStreak > stats.longestStreak) {
                        stats.longestStreak = stats.winStreak;
                    }
                    
                    const currentHighScore = parseInt(localStorage.getItem(this.highScoreKey)) || Infinity;
                    if (this.attempts < currentHighScore) {
                        localStorage.setItem(this.highScoreKey, this.attempts);
                        this.loadHighScore();
                        this.elements.message.innerText += " (NEW RECORD)";
                        showNewHighScoreBanner();
                    }
                    
                    startConfetti();

                } else if (this.attempts >= this.maxAttempts) {
                    colorClass = 'lose';
                    hintText = "FAILURE";
                    feedbackIcon = '‚ùå';
                    this.elements.message.innerText = `‚ùå FAILURE. Secret code was ${this.randomNumber}. Resetting system...`;
                    gameEnded = true;
                    stats.winStreak = 0;
                    
                    showGameOverBanner();
                    
                } else { 
                    let trueDirection = guess > this.randomNumber ? "HIGH" : "LOW";
                    let displayedDirection = this.inverseModeActive ? (trueDirection === "HIGH" ? "LOW" : "HIGH") : trueDirection;

                    if (proximity <= 5) {
                        colorClass = 'almost';
                        feedbackIcon = '‚ú®';
                        this.elements.message.innerText = `${feedbackIcon} Proximity Alert: ${displayedDirection}. Minor adjustment needed (within 5).`;
                        hintText = `Minor ${displayedDirection}`;
                    } else if (proximity <= 15) {
                        colorClass = displayedDirection === "HIGH" ? 'high' : 'low';
                        feedbackIcon = displayedDirection === "HIGH" ? 'üü°' : 'üîµ';
                        this.elements.message.innerText = `${feedbackIcon} Code MAJOR ${displayedDirection}. Significant adjustment required (within 15).`;
                        hintText = `Major ${displayedDirection}`;
                    } else {
                        colorClass = displayedDirection === "HIGH" ? 'high' : 'low';
                        feedbackIcon = displayedDirection === "HIGH" ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
                        this.elements.message.innerText = `${feedbackIcon} Code TOO ${displayedDirection}. Wide adjustment needed.`;
                        hintText = `TOO ${displayedDirection}`;
                    }
                    
                    if (this.inverseModeActive) {
                        hintText = `üîÑ FAKED ${hintText}`;
                    }
                }
                
                this.elements.message.classList.add(colorClass);

                const newEntry = document.createElement("div");
                newEntry.className = "history-entry";
                newEntry.innerHTML = `#${this.attempts}: <strong>${guess}</strong> (${feedbackIcon} ${hintText})`;
                
                if (this.attempts === 1) { guessesList.innerHTML = ''; }
                guessesList.prepend(newEntry);
                guessesList.scrollTop = 0;
                
                this.elements.guessInput.value = ""; 
                this.elements.guessInput.focus();

                if (gameEnded) {
                    this.gameActive = false;
                    this.elements.guessInput.setAttribute("disabled", true);
                    this.elements.submitBtn.setAttribute("disabled", true);
                    startRedirectTimer(() => this.restartGame());
                    saveStats(); 
                }

            },

            restartGame() {
                clearTimersAndEffects();
                
                this.elements.gameDiv.style.display = "none";
                this.elements.maxGuesses.value = "7";
                this.elements.guessInput.value = "";
                this.elements.message.innerText = "";
                this.elements.message.className = 'msg'; 

                this.elements.maxGuesses.removeAttribute("disabled");
                this.elements.inverseToggle.removeAttribute("disabled"); 
                this.elements.startBtn.style.display = "inline-block";
                
                showGameControls(false);
                this.elements.guessInput.removeAttribute("disabled");
                this.elements.submitBtn.removeAttribute("disabled");
                this.gameActive = false;
            }
        };

        // --- UI & MODAL FUNCTIONS ---

        function closeAllFloatingPanels() {
            settingsModal.classList.remove('visible');
            supportModal.classList.remove('visible');
            instructionsBox.classList.remove('visible');
            historyPanel.classList.remove('visible');
        }

        function toggleSettingsModal() { closeAllFloatingPanels(); settingsModal.classList.toggle('visible'); }
        window.closeSettingsModal = function() { settingsModal.classList.remove('visible'); }
        
        function toggleSupportModal() { 
            closeAllFloatingPanels(); 
            supportModal.classList.toggle('visible'); 
            if (supportModal.classList.contains('visible')) { greetAndShowMenu(); }
        }
        window.closeSupportModal = function() { supportModal.classList.remove('visible'); }

        function togglePanel(panel) {
            const panels = [instructionsBox, historyPanel, settingsModal, supportModal];
            panels.forEach(p => { 
                if (p !== panel && p.classList.contains('visible')) { p.classList.remove('visible'); } 
            });
            panel.classList.toggle('visible');
        }

        function showGameControls(show) {
            const display = show ? "none" : "inline-block";
            document.getElementById("settingsIcon").style.display = display;
            document.getElementById("supportIcon").style.display = display;
            document.getElementById("historyBtn").style.display = show ? "inline-block" : "none";
            closeAllFloatingPanels();
        }

        // --- STATS AND LOCAL STORAGE ---

        function calculateWinRate() { return stats.gamesPlayed > 0 ? ((stats.wins / stats.gamesPlayed) * 100).toFixed(1) + "%" : "0%"; }

        function updateStatsDisplay() {
            document.getElementById('stat-games').innerText = stats.gamesPlayed;
            document.getElementById('stat-wins').innerText = stats.wins;
            document.getElementById('stat-winrate').innerText = calculateWinRate();
            document.getElementById('stat-streak').innerText = stats.winStreak;
            document.getElementById('stat-max-streak').innerText = stats.longestStreak;
            guessMaster.loadHighScore();
        }

        function loadStats() {
            const savedStats = localStorage.getItem('guessNumberStats');
            if (savedStats) { stats = {...stats, ...JSON.parse(savedStats)}; }
            if (stats.theme === 'light') { body.classList.add('light-mode'); themeToggle.checked = true; }
            soundToggle.checked = stats.soundEnabled;
            updateStatsDisplay();
            chatHistory = JSON.parse(localStorage.getItem('guessNumberChatHistory')) || [];
        }

        function saveStats() {
            stats.theme = themeToggle.checked ? 'light' : 'dark';
            localStorage.setItem('guessNumberStats', JSON.stringify(stats));
            localStorage.setItem('guessNumberChatHistory', JSON.stringify(chatHistory));
            updateStatsDisplay();
        }

        window.resetHighScoreOnly = function() {
            if (confirm(`‚ö†Ô∏è SECURITY PROTOCOL: Are you sure you want to wipe ONLY the High Score?`)) {
                localStorage.removeItem(guessMaster.highScoreKey);
                loadStats(); guessMaster.restartGame(); greetAndShowMenu();
            }
        }

        window.resetAllStats = function() {
            if (confirm("‚ö†Ô∏è SECURITY PROTOCOL: Are you sure you want to wipe ALL game statistics (High Scores, Stats, and Streaks)? This action cannot be undone.")) {
                localStorage.removeItem(guessMaster.highScoreKey);
                localStorage.removeItem('guessNumberStats');
                localStorage.removeItem('guessNumberChatHistory'); 
                const currentSoundSetting = stats.soundEnabled;
                const currentThemeSetting = stats.theme; 
                stats = { gamesPlayed: 0, wins: 0, winStreak: 0, longestStreak: 0, soundEnabled: currentSoundSetting, theme: currentThemeSetting };
                loadStats(); guessMaster.restartGame(); greetAndShowMenu();
            }
        }
        
        // --- CHAT LOGIC ---

        function addMessageToChat(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            messageDiv.innerHTML = text;
            supportBody.appendChild(messageDiv);
            supportBody.scrollTop = supportBody.scrollHeight;
            chatHistory.push({ text, sender });
        }

        function greetAndShowMenu() {
            supportBody.innerHTML = '';
            // supportContentArea.style.display = 'none'; // Unnecessary line

            addMessageToChat("Hello User. Welcome to Protocol Support. How may I assist with the Guess Master simulation?", 'ai');
            
            const menu = supportMenuTemplate.cloneNode(true);
            menu.removeAttribute('style');
            supportBody.appendChild(menu);
            supportBody.scrollTop = supportBody.scrollHeight;
        }

        window.handleMenuSelection = function(panelName, buttonElement) {
            addMessageToChat(`Accessing: ${buttonElement.innerText.replace(/\([\s\S]*?\)/g, '').trim()}`, 'user');
            
            // supportContentArea.style.display = 'block'; // Unnecessary line
            
            // The content panels are moved from supportContentArea to supportBody
            document.querySelectorAll('.chat-info-panel').forEach(p => p.style.display = 'none');
            const selectedPanel = document.getElementById(panelName + 'PanelContent');
            selectedPanel.style.display = 'block';
            
            if (panelName === 'stats') { updateStatsDisplay(); }

            const menu = supportBody.querySelector('#support-menu-options-template');
            if (menu) menu.remove();

            // Move the actual panel element into the body
            supportBody.appendChild(selectedPanel);
            supportBody.scrollTop = supportBody.scrollHeight;
        }
        
        // --- FIX IMPLEMENTED HERE ---
        window.returnToMainMenu = function() {
            const contentArea = document.getElementById('supportContentArea');
            // Iterate over all info panels
            document.querySelectorAll('.chat-info-panel').forEach(p => {
                // If the panel is currently a child of the chat body
                if (p.parentNode === supportBody) { 
                    // Move the element back to its original hidden container (#supportContentArea)
                    contentArea.appendChild(p); 
                }
            });
            // Re-render the main menu
            greetAndShowMenu();
        }

        // --- CONFETTI & TIMERS ---

        function showNewHighScoreBanner() {
            const banner = document.getElementById("highScoreBanner");
            banner.classList.remove('active'); 
            void banner.offsetWidth; 
            banner.classList.add('active'); 
            setTimeout(() => { banner.classList.remove('active'); }, 5000); 
        }

        function showGameOverBanner() {
            const banner = document.getElementById("gameOverBanner");
            banner.classList.remove('active'); 
            void banner.offsetWidth; 
            banner.classList.add('active'); 
            setTimeout(() => { banner.classList.remove('active'); }, 5000); 
        }

        function startConfetti() {
            const particleCount = stats.soundEnabled ? 10 : 5;
            const duration = stats.soundEnabled ? 3500 : 2500;

            confettiInterval = setInterval(() => {
                for (let i = 0; i < particleCount; i++) {
                    let confetti = document.createElement("div");
                    confetti.className = "confetti";
                    confetti.style.left = Math.random() * window.innerWidth + "px";
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), duration); 
                }
            }, 200);
            setTimeout(() => clearInterval(confettiInterval), duration);
        }
        
        function clearTimersAndEffects() {
            clearInterval(confettiInterval);
            clearInterval(redirectTimer);
            document.querySelectorAll(".confetti").forEach(c => c.remove());
            document.getElementById("highScoreBanner").classList.remove('active');
            document.getElementById("gameOverBanner").classList.remove('active');
        }

        function startRedirectTimer(callback) {
            let timeLeft = 5;
            const countdownSpan = document.createElement('span');
            countdownSpan.id = 'countdown';
            
            countdownSpan.innerText = ` (Redirecting in ${timeLeft}s...)`;
            guessMaster.elements.message.appendChild(countdownSpan);

            redirectTimer = setInterval(() => {
                timeLeft--;
                countdownSpan.innerText = ` (Redirecting in ${timeLeft}s...)`;

                if (timeLeft <= 0) {
                    clearInterval(redirectTimer);
                    callback();
                }
            }, 1000);
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        
        themeToggle.addEventListener('change', () => { body.classList.toggle('light-mode'); saveStats(); });
        soundToggle.addEventListener('change', () => { stats.soundEnabled = soundToggle.checked; saveStats(); });
        infoButton.addEventListener('click', () => togglePanel(instructionsBox));
        historyButton.addEventListener('click', () => togglePanel(historyPanel));

        function initializeGame() {
            loadStats();
            rulesTitle.innerText = "GUESS MASTER PROTOCOL GUIDELINES";
            rulesContent.innerHTML = guessMaster.ruleContent;
            historyTitle.innerText = "GUESS MASTER LOG";
            guessMaster.loadHighScore();
        }

        window.onload = initializeGame;
        
    </script>
</body>
</html>